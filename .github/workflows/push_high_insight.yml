name: Push High-Insight Dataset
on:
  workflow_dispatch:

jobs:
  push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ì €ìž¥ì†Œì— ì“°ê¸° ê¶Œí•œ ë¶€ì—¬

    steps:
      - name: ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true
          fetch-depth: 0

      - name: ðŸ›  Ensure jq is installed
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
          jq --version

      - name: ðŸ”– í˜„ìž¬ ì»¤ë°‹ ì •ë³´ ì¶œë ¥
        run: |
          echo "ðŸ” SHA: $(git rev-parse HEAD)"
          echo "ðŸ“ Commit message: $(git log -1 --pretty=%B)"

      - name: ðŸ”§ JSON ë©”íƒ€ë°ì´í„° ì£¼ìž…
        run: |
          SHA=$(git rev-parse HEAD)
          DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          MSG=$(git log -1 --pretty=%B | tr '\n' ' ')
          # Wrap the existing array into an object with metadata and qa fields
          jq --arg sha "$SHA" \
             --arg date "$DATE" \
             --arg msg "$MSG" \
             '. |= {"metadata": {commit: $sha, timestamp: $date, message: $msg}, "qa": .}' \
             data/qa/high_insight_qa_dataset.json > tmp.json && mv tmp.json data/qa/high_insight_qa_dataset.json

      - name: âœ… Validate JSON
        run: |
          jq empty data/qa/high_insight_qa_dataset.json

      - name: Push high_insight_qa_dataset.json
        run: |
          git add data/qa/high_insight_qa_dataset.json
          git diff --cached --quiet || git commit -m "chore: update high_insight_qa_dataset.json [skip ci]"
          git push